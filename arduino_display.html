<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arduino ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</title>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”§ Arduino ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‹ã‚¿ãƒ¼</h1>

      <div class="status-bar">
        <div class="connection-status" id="connectionStatus">
          <span class="disconnected">âš ï¸ æ¥ç¶šå¾…æ©Ÿä¸­...</span>
        </div>
        <div class="timestamp" id="lastUpdate">æœ€çµ‚æ›´æ–°: --:--:--</div>
      </div>

      <div class="error-message" id="errorMessage">
        æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
      </div>

      <div class="data-display" id="dataDisplay">
        <!-- ãƒ‡ãƒ¼ã‚¿ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
      </div>

      <div class="raw-data">
        <h3>ğŸ“Š å—ä¿¡ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚°</h3>
        <div class="data-log" id="dataLog">
          <div class="log-entry">ãƒ­ã‚°é–‹å§‹...</div>
        </div>
      </div>
    </div>

    <script>
      class ArduinoDataDisplay {
        constructor() {
          this.socket = null;
          this.dataCards = new Map();
          this.maxLogEntries = 50;
          this.reconnectAttempts = 0;
          this.maxReconnectAttempts = 5;

          this.initializeWebSocket();
        }

        initializeWebSocket() {
          try {
            this.socket = new WebSocket("ws://localhost:8080");

            this.socket.addEventListener("open", (event) => {
              console.log("Arduino WebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ");
              this.updateConnectionStatus(true);
              this.addLogEntry("âœ… WebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ");
              this.reconnectAttempts = 0;
              this.hideError();
            });

            this.socket.addEventListener("message", (event) => {
              this.handleArduinoData(event.data);
            });

            this.socket.addEventListener("close", (event) => {
              console.log("WebSocketæ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ");
              this.updateConnectionStatus(false);
              this.addLogEntry("âŒ WebSocketæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ");
              this.attemptReconnect();
            });

            this.socket.addEventListener("error", (event) => {
              console.error("WebSocketã‚¨ãƒ©ãƒ¼:", event);
              this.showError("WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
              this.addLogEntry("âš ï¸ WebSocketã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            });
          } catch (error) {
            console.error("WebSocketåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
            this.showError("WebSocketã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        }

        handleArduinoData(rawData) {
          try {
            this.updateLastUpdateTime();

            // JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’è©¦ã™
            let data;
            try {
              data = JSON.parse(rawData);
            } catch (jsonError) {
              // JSONä»¥å¤–ã®å ´åˆã¯æ–‡å­—åˆ—ã¨ã—ã¦å‡¦ç†
              data = { value: rawData.toString().trim() };
            }

            this.addLogEntry(`ğŸ“¥ å—ä¿¡: ${rawData}`);
            this.updateDataDisplay(data);
          } catch (error) {
            console.error("ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
            this.addLogEntry(`âŒ ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        updateDataDisplay(data) {
          // ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¡¨ç¤º
          Object.keys(data).forEach((key) => {
            const value = data[key];
            this.createOrUpdateDataCard(key, value);
          });
        }

        createOrUpdateDataCard(label, value) {
          const cardId = `card-${label}`;
          let card = document.getElementById(cardId);

          if (!card) {
            // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
            card = document.createElement("div");
            card.className = "data-card";
            card.id = cardId;

            card.innerHTML = `
                        <div class="data-label">${this.formatLabel(label)}</div>
                        <div class="data-value" id="value-${label}">--</div>
                        <div class="data-unit" id="unit-${label}"></div>
                    `;

            document.getElementById("dataDisplay").appendChild(card);
          }

          // å€¤ã‚’æ›´æ–°
          const valueElement = document.getElementById(`value-${label}`);
          const unitElement = document.getElementById(`unit-${label}`);

          if (valueElement) {
            valueElement.textContent = this.formatValue(value);
            valueElement.classList.add("pulse");
            setTimeout(() => valueElement.classList.remove("pulse"), 500);
          }

          // å˜ä½ã‚’æ¨å®šã—ã¦è¨­å®š
          if (unitElement) {
            unitElement.textContent = this.guessUnit(label, value);
          }
        }

        formatLabel(label) {
          // ãƒ©ãƒ™ãƒ«ã‚’æ—¥æœ¬èªã«å¤‰æ›
          const labelMap = {
            temperature: "æ¸©åº¦",
            humidity: "æ¹¿åº¦",
            pressure: "æ°—åœ§",
            distance: "è·é›¢",
            voltage: "é›»åœ§",
            current: "é›»æµ",
            speed: "é€Ÿåº¦",
            angle: "è§’åº¦",
            value: "å€¤",
            sensor: "ã‚»ãƒ³ã‚µãƒ¼å€¤",
            data: "ãƒ‡ãƒ¼ã‚¿",
          };

          return labelMap[label.toLowerCase()] || label;
        }

        formatValue(value) {
          if (typeof value === "number") {
            return value.toFixed(2);
          }
          return value.toString();
        }

        guessUnit(label, value) {
          const lowerLabel = label.toLowerCase();

          if (lowerLabel.includes("temp")) return "Â°C";
          if (lowerLabel.includes("humid")) return "%";
          if (lowerLabel.includes("pressure")) return "hPa";
          if (lowerLabel.includes("distance")) return "cm";
          if (lowerLabel.includes("voltage")) return "V";
          if (lowerLabel.includes("current")) return "A";
          if (lowerLabel.includes("speed")) return "m/s";
          if (lowerLabel.includes("angle")) return "Â°";

          return "";
        }

        updateConnectionStatus(connected) {
          const statusElement = document.getElementById("connectionStatus");
          if (connected) {
            statusElement.innerHTML =
              '<span class="connected">âœ… Arduinoæ¥ç¶šä¸­</span>';
          } else {
            statusElement.innerHTML =
              '<span class="disconnected">âŒ Arduinoåˆ‡æ–­</span>';
          }
        }

        updateLastUpdateTime() {
          const now = new Date();
          const timeString = now.toLocaleTimeString("ja-JP");
          document.getElementById(
            "lastUpdate"
          ).textContent = `æœ€çµ‚æ›´æ–°: ${timeString}`;
        }

        addLogEntry(message) {
          const logContainer = document.getElementById("dataLog");
          const entry = document.createElement("div");
          entry.className = "log-entry";

          const timestamp = new Date().toLocaleTimeString("ja-JP");
          entry.textContent = `[${timestamp}] ${message}`;

          logContainer.appendChild(entry);

          // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªæ•°ã‚’åˆ¶é™
          const entries = logContainer.querySelectorAll(".log-entry");
          if (entries.length > this.maxLogEntries) {
            entries[0].remove();
          }

          // æœ€æ–°ã‚¨ãƒ³ãƒˆãƒªã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          logContainer.scrollTop = logContainer.scrollHeight;
        }

        showError(message) {
          const errorElement = document.getElementById("errorMessage");
          errorElement.textContent = message;
          errorElement.style.display = "block";
        }

        hideError() {
          document.getElementById("errorMessage").style.display = "none";
        }

        attemptReconnect() {
          if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            const delay = Math.min(
              1000 * Math.pow(2, this.reconnectAttempts),
              10000
            );

            this.addLogEntry(
              `ğŸ”„ ${delay / 1000}ç§’å¾Œã«å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™... (${
                this.reconnectAttempts
              }/${this.maxReconnectAttempts})`
            );

            setTimeout(() => {
              this.initializeWebSocket();
            }, delay);
          } else {
            this.showError(
              "æœ€å¤§å†æ¥ç¶šå›æ•°ã«é”ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚"
            );
            this.addLogEntry(
              "âŒ å†æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚"
            );
          }
        }
      }

      // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      document.addEventListener("DOMContentLoaded", () => {
        new ArduinoDataDisplay();
      });
    </script>
  </body>
</html>
