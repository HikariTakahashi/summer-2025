<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arduino „Éá„Éº„ÇøË°®Á§∫</title>

    <!-- ‚ñº styles.css „Çí„Ç§„É≥„É©„Ç§„É≥Âåñ + ËøΩÂä†„Çπ„Çø„Ç§„É´„ÅßÁµ±Âêà -->
    <style>
      :root {
        --bg: #f3f4f6;
        --surface: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --ok: #16a34a;
        --warn: #f59e0b;
        --err: #ef4444;
        --radius: 24px;
        --shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
        --border: #eceef1;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
      }

      /* ====== 1) Êó¢Â≠ò Arduino ÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ ====== */
      .container {
        max-width: 1100px;
        margin: 40px auto 80px;
        padding: 0 20px;
      }
      h1 {
        margin: 0 0 16px;
        font-size: clamp(22px, 3.2vw, 40px);
        font-weight: 800;
        letter-spacing: 0.02em;
      }
      .status-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px 18px;
        box-shadow: var(--shadow);
      }
      .connection-status span {
        font-weight: 600;
      }
      .connected {
        color: var(--ok);
      }
      .disconnected {
        color: var(--err);
      }
      .timestamp {
        color: var(--muted);
        font-size: 14px;
      }

      .error-message {
        display: none;
        margin-top: 12px;
        background: #fff5f5;
        color: #b91c1c;
        border: 1px solid #fecaca;
        padding: 10px 14px;
        border-radius: 12px;
      }

      .data-display {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
        margin-top: 18px;
      }
      .data-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px;
        box-shadow: var(--shadow);
      }
      .data-label {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 6px;
      }
      .data-value {
        font-size: 28px;
        font-weight: 800;
        line-height: 1;
      }
      .data-unit {
        margin-top: 6px;
        color: var(--muted);
        font-size: 13px;
      }
      .pulse {
        animation: pulse 0.5s ease;
      }
      @keyframes pulse {
        from {
          transform: scale(1);
        }
        50% {
          transform: scale(1.03);
        }
        to {
          transform: scale(1);
        }
      }

      .raw-data {
        margin-top: 24px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
      }
      .raw-data h3 {
        margin: 0 0 10px;
      }
      .data-log {
        max-height: 260px;
        overflow: auto;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size: 12px;
        background: #fbfbfc;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
      }
      .log-entry {
        padding: 4px 0;
        border-bottom: 1px dashed #eceff3;
      }
      .log-entry:last-child {
        border-bottom: 0;
      }

      /* ====== 2) ÊπøÂ∫¶„Ç´„Éº„Éâ + „Ç∞„É©„ÉïÔºà2„Å§ÁõÆHTML„ÅÆ„Çπ„Çø„Ç§„É´Ôºâ ====== */
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 32px 40px;
        box-shadow: var(--shadow);
        min-width: 320px;
      }
      .value-row {
        display: flex;
        align-items: flex-end;
        justify-content: center;
        gap: 10px;
      }
      .value {
        font-size: clamp(56px, 10vw, 96px);
        font-weight: 800;
        line-height: 1;
      }
      .unit {
        font-size: 24px;
        color: var(--muted);
      }
      .ts {
        margin-top: 14px;
        font-size: 14px;
        color: var(--muted);
        letter-spacing: 0.02em;
        text-align: center;
      }
      .status {
        margin-top: 10px;
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: center;
        color: var(--muted);
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ccc;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.03);
      }
      .dot.ok {
        background: var(--ok);
        box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.18);
      }
      .dot.connecting {
        background: var(--warn);
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.18);
      }
      .dot.offline {
        background: var(--err);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
      }

      .chart-wrap {
        width: min(960px, 100%);
        margin: 18px auto 0;
      }
      .controls {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 10px;
      }
      .btn {
        background: #0d6efd;
        color: #fff;
        border: 0;
        border-radius: 999px;
        padding: 8px 14px;
        cursor: pointer;
      }
      .btn.outline {
        background: transparent;
        color: #0d6efd;
        border: 1px solid #0d6efd;
      }

      /* ÊπøÂ∫¶„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„Åæ„Å®„Åæ„Çä */
      .humidity-section {
        margin-top: 28px;
      }

      /* Â∞è„Åï„Å™ÁîªÈù¢„Åß„ÅÆ‰ΩôÁôΩË™øÊï¥ */
      @media (max-width: 640px) {
        .status-bar {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>

    <!-- ‚ñº Chart.jsÔºà„É©„Ç§„Éñ„Ç∞„É©„ÉïÁî®Ôºâ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  </head>

  <body>
    <div class="container">
      <h1>üîß Arduino „Éá„Éº„Çø„É¢„Éã„Çø„Éº</h1>

      <!-- Êé•Á∂ö„Éª„Çø„Ç§„É†„Çπ„Çø„É≥„Éó -->
      <div class="status-bar">
        <div class="connection-status" id="connectionStatus">
          <span class="disconnected">‚ö†Ô∏è Êé•Á∂öÂæÖÊ©ü‰∏≠...</span>
        </div>
        <div class="timestamp" id="lastUpdate">ÊúÄÁµÇÊõ¥Êñ∞: --:--:--</div>
      </div>

      <!-- „Ç®„É©„Éº„Éê„Éä„Éº -->
      <div class="error-message" id="errorMessage">
        Êé•Á∂ö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü
      </div>

      <!-- ‚ñº ÊπøÂ∫¶„Ç´„Éº„Éâ + „É©„Ç§„Éñ„Ç∞„É©„ÉïÔºàÁµ±ÂêàÔºâ -->
      <section class="humidity-section">
        <section class="card">
          <div class="value-row">
            <span id="hum" class="value" aria-live="polite">--</span>
            <span class="unit">%</span>
          </div>
          <div id="ts" class="ts">--:--:--</div>

          <div class="status">
            <span id="dot" class="dot offline"></span>
            <span id="statusText">Êú™Êé•Á∂ö</span>
          </div>
        </section>

        <section class="chart-wrap">
          <canvas id="humChart" height="220"></canvas>
          <div class="controls">
            <button id="clearBtn" class="btn outline">„É™„Çª„ÉÉ„Éà</button>
            <button id="csvBtn" class="btn">CSV‰øùÂ≠ò</button>
          </div>
        </section>
      </section>

      <!-- Ê±éÁî®„Éá„Éº„Çø„Ç´„Éº„ÉâÔºàÂèó‰ø°„Éá„Éº„Çø„ÅÆÂêÑ„Ç≠„Éº„ÇíËá™Âãï„Åß„Ç´„Éº„ÉâÂåñÔºâ -->
      <div class="data-display" id="dataDisplay">
        <div class="data-card">
          <div class="data-label">„Éí„É≥„Éà</div>
          <div class="data-value">JSON „ÅÆÂêÑ„Ç≠„Éº„Åå„Ç´„Éº„Éâ„ÅßÂ¢ó„Åà„Åæ„Åô</div>
          <div class="data-unit"></div>
        </div>
      </div>

      <!-- Âèó‰ø°„É≠„Ç∞ -->
      <div class="raw-data">
        <h3>üìä Âèó‰ø°„Éá„Éº„Çø„É≠„Ç∞</h3>
        <div class="data-log" id="dataLog">
          <div class="log-entry">„É≠„Ç∞ÈñãÂßã...</div>
        </div>
      </div>
    </div>

    <!-- ‚ñº „Ç¢„Éó„É™Êú¨‰Ωì -->
    <script>
      class ArduinoDataDisplay {
        constructor() {
          this.socket = null;
          this.dataCards = new Map();
          this.maxLogEntries = 50;
          this.reconnectAttempts = 0;
          this.maxReconnectAttempts = 5;

          // ÊπøÂ∫¶Áî®
          this.humHistory = []; // {time: "HH:mm:ss", value: number}
          this.maxPoints = 120;
          this.humChart = null;

          this.initializeChart();
          this.initializeWebSocket();
          this.bindButtons();
          this.setStatus("connecting", "Êé•Á∂öÂæÖÊ©ü‰∏≠...");
        }

        /* ========== WebSocket ========== */
        initializeWebSocket() {
          try {
            this.socket = new WebSocket("ws://localhost:8080");

            this.socket.addEventListener("open", () => {
              console.log("Arduino WebSocket„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü");
              this.updateConnectionStatus(true);
              this.addLogEntry("‚úÖ WebSocket„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü");
              this.reconnectAttempts = 0;
              this.hideError();
              this.setStatus("ok", "Êé•Á∂ö‰∏≠");
            });

            this.socket.addEventListener("message", (event) => {
              this.handleArduinoData(event.data);
            });

            this.socket.addEventListener("close", () => {
              console.log("WebSocketÊé•Á∂ö„ÅåÈñâ„Åò„Çâ„Çå„Åæ„Åó„Åü");
              this.updateConnectionStatus(false);
              this.addLogEntry("‚ùå WebSocketÊé•Á∂ö„ÅåÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü");
              this.setStatus("offline", "ÂàáÊñ≠");
              this.attemptReconnect();
            });

            this.socket.addEventListener("error", (event) => {
              console.error("WebSocket„Ç®„É©„Éº:", event);
              this.showError("WebSocketÊé•Á∂ö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü");
              this.addLogEntry("‚ö†Ô∏è WebSocket„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü");
              this.setStatus("offline", "„Ç®„É©„Éº");
            });
          } catch (error) {
            console.error("WebSocketÂàùÊúüÂåñ„Ç®„É©„Éº:", error);
            this.showError("WebSocket„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
            this.setStatus("offline", "ÂàùÊúüÂåñÂ§±Êïó");
          }
        }

        attemptReconnect() {
          if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            const delay = Math.min(
              1000 * Math.pow(2, this.reconnectAttempts),
              10000
            );

            this.addLogEntry(
              `üîÑ ${delay / 1000}ÁßíÂæå„Å´ÂÜçÊé•Á∂ö„ÇíË©¶„Åø„Åæ„Åô... (${
                this.reconnectAttempts
              }/${this.maxReconnectAttempts})`
            );

            setTimeout(() => {
              this.setStatus("connecting", "ÂÜçÊé•Á∂ö‰∏≠...");
              this.initializeWebSocket();
            }, delay);
          } else {
            this.showError(
              "ÊúÄÂ§ßÂÜçÊé•Á∂öÂõûÊï∞„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
            );
            this.addLogEntry(
              "‚ùå ÂÜçÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
            );
            this.setStatus("offline", "ÂÜçÊé•Á∂öÂ§±Êïó");
          }
        }

        /* ========== Âèó‰ø°Âá¶ÁêÜ ========== */
        handleArduinoData(rawData) {
          try {
            this.updateLastUpdateTime();
            const nowStr = new Date().toLocaleTimeString("ja-JP");
            document.getElementById("ts").textContent = nowStr;

            let data;
            try {
              data = JSON.parse(rawData);
            } catch {
              // "48.1%" „ÇÑ "humidity:48.1" „ÅÆ„Çà„ÅÜ„Å™ÊñáÂ≠óÂàó„Å´„ÇÇÂØæÂøú
              data = this.parseFallback(rawData);
            }

            this.addLogEntry(
              `üì• Âèó‰ø°: ${
                typeof rawData === "string" ? rawData : JSON.stringify(rawData)
              }`
            );
            this.updateDataDisplay(data);

            // ÊπøÂ∫¶ÊäΩÂá∫Ôºà„Ç≠„ÉºÂÄôË£ú„ÇÑ % Âê´„ÅøÊñáÂ≠óÂàó„Åã„ÇâËá™ÂãïÂà§ÂÆöÔºâ
            const hum = this.extractHumidity(data);
            if (typeof hum === "number" && isFinite(hum)) {
              this.updateHumidityUI(hum, nowStr);
              this.updateChart(hum, nowStr);
            }
          } catch (error) {
            console.error("„Éá„Éº„ÇøÂá¶ÁêÜ„Ç®„É©„Éº:", error);
            this.addLogEntry(`‚ùå „Éá„Éº„ÇøÂá¶ÁêÜ„Ç®„É©„Éº: ${error.message}`);
          }
        }

        parseFallback(text) {
          // "humidity:48.1" / "ÊπøÂ∫¶=48.1%" / "48.1%" / 48.1 „Å™„Å©„Çí„Ç´„Éê„Éº
          if (typeof text !== "string") return { value: String(text) };
          const trimmed = text.trim();

          // Êï∞ÂÄ§„Å†„Åë„Å™„Çâ value „Å®„Åó„Å¶Êâ±„ÅÜ
          const num = parseFloat(trimmed.replace("%", ""));
          if (
            !isNaN(num) &&
            (trimmed.match(/[0-9.]/g) || []).length >=
              String(num).replace(".", "").length
          ) {
            // % „Åå„ÅÇ„Çå„Å∞ÊπøÂ∫¶„Å®„Åø„Å™„Åô
            if (trimmed.includes("%")) return { humidity: num };
            return { value: trimmed, humidity: num }; // Êé®ÂÆö
          }

          // "humidity: 48.1" / "ÊπøÂ∫¶=48.1%" „Å™„Å©
          const re = /(humidity|hum|ÊπøÂ∫¶)\s*[:=]\s*([0-9]+(?:\.[0-9]+)?)%?/i;
          const m = trimmed.match(re);
          if (m) return { humidity: parseFloat(m[2]) };

          return { value: trimmed };
        }

        extractHumidity(obj) {
          if (!obj || typeof obj !== "object") return undefined;
          // ÂÄôË£ú„Ç≠„Éº„ÇíÂÑ™ÂÖàÁöÑ„Å´Ë¶ã„Çã
          const keys = Object.keys(obj);
          for (const k of keys) {
            const lower = k.toLowerCase();
            if (lower.includes("humid") || k === "ÊπøÂ∫¶") {
              const v = parseFloat(String(obj[k]).toString().replace("%", ""));
              if (!isNaN(v)) return v;
            }
          }
          // ÂÄôË£ú„Ç≠„Éº„ÅåÁÑ°„ÅÑ„Åå„ÄÅÂÄ§„Å´ % „Åå‰ªò„ÅÑ„Å¶„ÅÑ„Çå„Å∞Êé°Áî®
          for (const k of keys) {
            const v = obj[k];
            if (typeof v === "string" && v.includes("%")) {
              const n = parseFloat(v.replace("%", ""));
              if (!isNaN(n)) return n;
            }
          }
          return undefined;
        }

        updateDataDisplay(data) {
          // ÂêÑ„Éó„É≠„Éë„ÉÜ„Ç£„Çí„Ç´„Éº„ÉâË°®Á§∫
          Object.keys(data).forEach((key) => {
            const value = data[key];
            this.createOrUpdateDataCard(key, value);
          });
        }

        createOrUpdateDataCard(label, value) {
          const safeId = label.replace(/[^a-zA-Z0-9_-]/g, "_");
          const cardId = `card-${safeId}`;
          let card = document.getElementById(cardId);

          if (!card) {
            card = document.createElement("div");
            card.className = "data-card";
            card.id = cardId;
            card.innerHTML = `
              <div class="data-label">${this.formatLabel(label)}</div>
              <div class="data-value" id="value-${safeId}">--</div>
              <div class="data-unit" id="unit-${safeId}"></div>
            `;
            document.getElementById("dataDisplay").appendChild(card);
          }

          const valueElement = document.getElementById(`value-${safeId}`);
          const unitElement = document.getElementById(`unit-${safeId}`);

          if (valueElement) {
            valueElement.textContent = this.formatValue(value);
            valueElement.classList.add("pulse");
            setTimeout(() => valueElement.classList.remove("pulse"), 500);
          }
          if (unitElement) {
            unitElement.textContent = this.guessUnit(label, value);
          }
        }

        formatLabel(label) {
          const map = {
            temperature: "Ê∏©Â∫¶",
            humidity: "ÊπøÂ∫¶",
            pressure: "Ê∞óÂúß",
            distance: "Ë∑ùÈõ¢",
            voltage: "ÈõªÂúß",
            current: "ÈõªÊµÅ",
            speed: "ÈÄüÂ∫¶",
            angle: "ËßíÂ∫¶",
            value: "ÂÄ§",
            sensor: "„Çª„É≥„Çµ„ÉºÂÄ§",
            data: "„Éá„Éº„Çø",
          };
          const lower = label.toLowerCase();
          return map[lower] || label;
        }

        formatValue(value) {
          if (typeof value === "number") return value.toFixed(2);
          const v = String(value);
          // "48.1%" „Å™„Å©„ÅØ„Åù„ÅÆ„Åæ„Åæ
          const maybeNum = parseFloat(v.replace("%", ""));
          if (!isNaN(maybeNum) && v.includes("%")) return v;
          return v;
        }

        guessUnit(label, value) {
          const lower = label.toLowerCase();
          if (lower.includes("temp")) return "¬∞C";
          if (lower.includes("humid")) return "%";
          if (lower.includes("pressure")) return "hPa";
          if (lower.includes("distance")) return "cm";
          if (lower.includes("voltage")) return "V";
          if (lower.includes("current")) return "A";
          if (lower.includes("speed")) return "m/s";
          if (lower.includes("angle")) return "¬∞";
          // ÂÄ§„Å´ % „ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Çå„Å∞Âçò‰Ωç„ÇíÂá∫„Åï„Å™„ÅÑÔºàÂÄ§„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅÔºâ
          if (typeof value === "string" && value.includes("%")) return "";
          return "";
        }

        updateConnectionStatus(connected) {
          const statusElement = document.getElementById("connectionStatus");
          if (connected) {
            statusElement.innerHTML =
              '<span class="connected">‚úÖ ArduinoÊé•Á∂ö‰∏≠</span>';
          } else {
            statusElement.innerHTML =
              '<span class="disconnected">‚ùå ArduinoÂàáÊñ≠</span>';
          }
        }

        updateLastUpdateTime() {
          const now = new Date();
          const timeString = now.toLocaleTimeString("ja-JP");
          document.getElementById(
            "lastUpdate"
          ).textContent = `ÊúÄÁµÇÊõ¥Êñ∞: ${timeString}`;
        }

        addLogEntry(message) {
          const log = document.getElementById("dataLog");
          const entry = document.createElement("div");
          entry.className = "log-entry";
          const timestamp = new Date().toLocaleTimeString("ja-JP");
          entry.textContent = `[${timestamp}] ${message}`;
          log.appendChild(entry);

          const entries = log.querySelectorAll(".log-entry");
          if (entries.length > this.maxLogEntries) entries[0].remove();
          log.scrollTop = log.scrollHeight;
        }

        showError(message) {
          const el = document.getElementById("errorMessage");
          el.textContent = message;
          el.style.display = "block";
        }
        hideError() {
          document.getElementById("errorMessage").style.display = "none";
        }

        /* ========== ÊπøÂ∫¶UI/Áä∂ÊÖã ========== */
        setStatus(kind, text) {
          const dot = document.getElementById("dot");
          const st = document.getElementById("statusText");
          if (dot) {
            dot.classList.remove("ok", "connecting", "offline");
            dot.classList.add(kind);
          }
          if (st) st.textContent = text ?? "";
        }

        updateHumidityUI(hum, timeStr) {
          const humEl = document.getElementById("hum");
          if (humEl) {
            humEl.textContent = hum.toFixed(1);
            humEl.classList.add("pulse");
            setTimeout(() => humEl.classList.remove("pulse"), 400);
          }
          const ts = document.getElementById("ts");
          if (ts) ts.textContent = timeStr;
        }

        /* ========== „Ç∞„É©„Éï ========== */
        initializeChart() {
          const ctx = document.getElementById("humChart")?.getContext("2d");
          if (!ctx || !window.Chart) return;
          this.humChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: [],
              datasets: [
                {
                  label: "ÊπøÂ∫¶(%)",
                  data: [],
                  tension: 0.25,
                  pointRadius: 0,
                },
              ],
            },
            options: {
              animation: false,
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { display: false },
                y: { min: 0, max: 100, ticks: { stepSize: 10 } },
              },
              plugins: { legend: { display: false } },
            },
          });
        }

        updateChart(hum, timeStr) {
          if (!this.humChart) return;
          const ds = this.humChart.data.datasets[0].data;
          const labels = this.humChart.data.labels;

          ds.push(hum);
          labels.push(timeStr);
          this.humHistory.push({ time: timeStr, value: hum });

          // Âè§„ÅÑÁÇπ„ÇíÈñìÂºï„Åç
          while (ds.length > this.maxPoints) {
            ds.shift();
            labels.shift();
          }
          while (this.humHistory.length > this.maxPoints) {
            this.humHistory.shift();
          }

          this.humChart.update("none");
        }

        bindButtons() {
          const clearBtn = document.getElementById("clearBtn");
          const csvBtn = document.getElementById("csvBtn");

          clearBtn?.addEventListener("click", () => {
            if (this.humChart) {
              this.humChart.data.labels = [];
              this.humChart.data.datasets[0].data = [];
              this.humChart.update();
            }
            this.humHistory = [];
            const humEl = document.getElementById("hum");
            if (humEl) humEl.textContent = "--";
            document.getElementById("ts").textContent = "--:--:--";
            this.addLogEntry("üßπ ÊπøÂ∫¶„Ç∞„É©„Éï„Å®Â±•Ê≠¥„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü");
          });

          csvBtn?.addEventListener("click", () => {
            if (this.humHistory.length === 0) {
              this.addLogEntry("‚ÑπÔ∏è CSVÂá∫Âäõ: „Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
              return;
            }
            const header = "time,humidity\n";
            const rows = this.humHistory
              .map((r) => `${r.time},${r.value.toFixed(2)}`)
              .join("\n");
            const blob = new Blob([header + rows], {
              type: "text/csv;charset=utf-8;",
            });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = `humidity_${this.timestampForFile()}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            this.addLogEntry("üíæ CSV„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
          });
        }

        timestampForFile() {
          const d = new Date();
          const pad = (n) => String(n).padStart(2, "0");
          return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(
            d.getDate()
          )}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
        }
      }

      // „Ç¢„Éó„É™ÈñãÂßã
      document.addEventListener("DOMContentLoaded", () => {
        new ArduinoDataDisplay();
      });
    </script>
  </body>
</html>
