<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arduino ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</title>

    <!-- â–¼ styles.css ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ– + è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ«ã§çµ±åˆ -->
    <style>
      :root {
        --bg: #f3f4f6;
        --surface: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --ok: #16a34a;
        --warn: #f59e0b;
        --err: #ef4444;
        --radius: 24px;
        --shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
        --border: #eceef1;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
      }

      /* ====== 1) æ—¢å­˜ Arduino ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« ====== */
      .container {
        max-width: 1100px;
        margin: 40px auto 80px;
        padding: 0 20px;
      }
      h1 {
        margin: 0 0 16px;
        font-size: clamp(22px, 3.2vw, 40px);
        font-weight: 800;
        letter-spacing: 0.02em;
      }
      .status-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px 18px;
        box-shadow: var(--shadow);
      }
      .connection-status span {
        font-weight: 600;
      }
      .connected {
        color: var(--ok);
      }
      .disconnected {
        color: var(--err);
      }
      .timestamp {
        color: var(--muted);
        font-size: 14px;
      }

      .error-message {
        display: none;
        margin-top: 12px;
        background: #fff5f5;
        color: #b91c1c;
        border: 1px solid #fecaca;
        padding: 10px 14px;
        border-radius: 12px;
      }

      .data-display {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
        margin-top: 18px;
      }
      .data-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px;
        box-shadow: var(--shadow);
      }
      .data-label {
        color: var(--muted);
        font-size: 14px;
        margin-bottom: 6px;
      }
      .data-value {
        font-size: 28px;
        font-weight: 800;
        line-height: 1;
      }
      .data-unit {
        margin-top: 6px;
        color: var(--muted);
        font-size: 13px;
      }
      .pulse {
        animation: pulse 0.5s ease;
      }
      @keyframes pulse {
        from {
          transform: scale(1);
        }
        50% {
          transform: scale(1.03);
        }
        to {
          transform: scale(1);
        }
      }

      .raw-data {
        margin-top: 24px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
      }
      .raw-data h3 {
        margin: 0 0 10px;
      }
      .data-log {
        max-height: 260px;
        overflow: auto;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size: 12px;
        background: #fbfbfc;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
      }
      .log-entry {
        padding: 4px 0;
        border-bottom: 1px dashed #eceff3;
      }
      .log-entry:last-child {
        border-bottom: 0;
      }

      /* ====== 2) æ¹¿åº¦ã‚«ãƒ¼ãƒ‰ + ã‚°ãƒ©ãƒ•ï¼ˆ2ã¤ç›®HTMLã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ ====== */
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 32px 40px;
        box-shadow: var(--shadow);
        min-width: 320px;
      }
      .value-row {
        display: flex;
        align-items: flex-end;
        justify-content: center;
        gap: 10px;
      }
      .value {
        font-size: clamp(56px, 10vw, 96px);
        font-weight: 800;
        line-height: 1;
      }
      .unit {
        font-size: 24px;
        color: var(--muted);
      }
      .ts {
        margin-top: 14px;
        font-size: 14px;
        color: var(--muted);
        letter-spacing: 0.02em;
        text-align: center;
      }
      .status {
        margin-top: 10px;
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: center;
        color: var(--muted);
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ccc;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.03);
      }
      .dot.ok {
        background: var(--ok);
        box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.18);
      }
      .dot.connecting {
        background: var(--warn);
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.18);
      }
      .dot.offline {
        background: var(--err);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
      }

      .chart-wrap {
        width: min(960px, 100%);
        margin: 18px auto 0;
      }
      .controls {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 10px;
      }
      .btn {
        background: #0d6efd;
        color: #fff;
        border: 0;
        border-radius: 999px;
        padding: 8px 14px;
        cursor: pointer;
      }
      .btn.outline {
        background: transparent;
        color: #0d6efd;
        border: 1px solid #0d6efd;
      }

      /* æ¹¿åº¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã¾ã¨ã¾ã‚Š */
      .humidity-section {
        margin-top: 28px;
      }

      /* å°ã•ãªç”»é¢ã§ã®ä½™ç™½èª¿æ•´ */
      @media (max-width: 640px) {
        .status-bar {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>

    <!-- â–¼ Chart.jsï¼ˆãƒ©ã‚¤ãƒ–ã‚°ãƒ©ãƒ•ç”¨ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  </head>

  <body>
    <div class="container">
      <h1>ğŸ”§ Arduino ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‹ã‚¿ãƒ¼</h1>

      <!-- æ¥ç¶šãƒ»ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— -->
      <div class="status-bar">
        <div class="connection-status" id="connectionStatus">
          <span class="disconnected">âš ï¸ æ¥ç¶šå¾…æ©Ÿä¸­...</span>
        </div>
        <div class="timestamp" id="lastUpdate">æœ€çµ‚æ›´æ–°: --:--:--</div>
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼ãƒãƒŠãƒ¼ -->
      <div class="error-message" id="errorMessage">
        æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
      </div>

      <!-- â–¼ æ¹¿åº¦ã‚«ãƒ¼ãƒ‰ + ãƒ©ã‚¤ãƒ–ã‚°ãƒ©ãƒ•ï¼ˆçµ±åˆï¼‰ -->
      <section class="humidity-section">
        <section class="card">
          <div class="value-row">
            <span id="hum" class="value" aria-live="polite">--</span>
            <span class="unit">%</span>
          </div>
          <div id="ts" class="ts">--:--:--</div>

          <div class="status">
            <span id="dot" class="dot offline"></span>
            <span id="statusText">æœªæ¥ç¶š</span>
          </div>
        </section>

        <section class="chart-wrap">
          <canvas id="humChart" height="220"></canvas>
          <div class="controls">
            <button id="clearBtn" class="btn outline">ãƒªã‚»ãƒƒãƒˆ</button>
            <button id="csvBtn" class="btn">CSVä¿å­˜</button>
          </div>
        </section>
      </section>

      <!-- æ±ç”¨ãƒ‡ãƒ¼ã‚¿ã‚«ãƒ¼ãƒ‰ï¼ˆå—ä¿¡ãƒ‡ãƒ¼ã‚¿ã®å„ã‚­ãƒ¼ã‚’è‡ªå‹•ã§ã‚«ãƒ¼ãƒ‰åŒ–ï¼‰ -->
      <div class="data-display" id="dataDisplay">
        <div class="data-card">
          <div class="data-label">ãƒ’ãƒ³ãƒˆ</div>
          <div class="data-value">JSON ã®å„ã‚­ãƒ¼ãŒã‚«ãƒ¼ãƒ‰ã§å¢—ãˆã¾ã™</div>
          <div class="data-unit"></div>
        </div>
      </div>

      <!-- å—ä¿¡ãƒ­ã‚° -->
      <div class="raw-data">
        <h3>ğŸ“Š å—ä¿¡ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚°</h3>
        <div class="data-log" id="dataLog">
          <div class="log-entry">ãƒ­ã‚°é–‹å§‹...</div>
        </div>
      </div>
    </div>

    <!-- â–¼ ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
    <script>
      class ArduinoDataDisplay {
        constructor() {
          this.socket = null;
          this.dataCards = new Map();
          this.maxLogEntries = 50;
          this.reconnectAttempts = 0;
          this.maxReconnectAttempts = 5;

          // æ¹¿åº¦ç”¨
          this.humHistory = []; // {time: "HH:mm:ss", value: number}
          this.maxPoints = 120;
          this.humChart = null;

          this.initializeChart();
          this.initializeWebSocket();
          this.bindButtons();
          this.setStatus("connecting", "æ¥ç¶šå¾…æ©Ÿä¸­...");
        }

        /* ========== WebSocket ========== */
        initializeWebSocket() {
          try {
            this.socket = new WebSocket("ws://localhost:8080");

            this.socket.addEventListener("open", () => {
              console.log("Arduino WebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ");
              this.updateConnectionStatus(true);
              this.addLogEntry("âœ… WebSocketã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ");
              this.reconnectAttempts = 0;
              this.hideError();
              this.setStatus("ok", "æ¥ç¶šä¸­");
            });

            this.socket.addEventListener("message", (event) => {
              this.handleArduinoData(event.data);
            });

            this.socket.addEventListener("close", () => {
              console.log("WebSocketæ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ");
              this.updateConnectionStatus(false);
              this.addLogEntry("âŒ WebSocketæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ");
              this.setStatus("offline", "åˆ‡æ–­");
              this.attemptReconnect();
            });

            this.socket.addEventListener("error", (event) => {
              console.error("WebSocketã‚¨ãƒ©ãƒ¼:", event);
              this.showError("WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
              this.addLogEntry("âš ï¸ WebSocketã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
              this.setStatus("offline", "ã‚¨ãƒ©ãƒ¼");
            });
          } catch (error) {
            console.error("WebSocketåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
            this.showError("WebSocketã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ");
            this.setStatus("offline", "åˆæœŸåŒ–å¤±æ•—");
          }
        }

        attemptReconnect() {
          if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            const delay = Math.min(
              1000 * Math.pow(2, this.reconnectAttempts),
              10000
            );

            this.addLogEntry(
              `ğŸ”„ ${delay / 1000}ç§’å¾Œã«å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™... (${
                this.reconnectAttempts
              }/${this.maxReconnectAttempts})`
            );

            setTimeout(() => {
              this.setStatus("connecting", "å†æ¥ç¶šä¸­...");
              this.initializeWebSocket();
            }, delay);
          } else {
            this.showError(
              "æœ€å¤§å†æ¥ç¶šå›æ•°ã«é”ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚"
            );
            this.addLogEntry(
              "âŒ å†æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚"
            );
            this.setStatus("offline", "å†æ¥ç¶šå¤±æ•—");
          }
        }

        /* ========== å—ä¿¡å‡¦ç† ========== */
        handleArduinoData(rawData) {
          try {
            this.updateLastUpdateTime();
            const nowStr = new Date().toLocaleTimeString("ja-JP");
            document.getElementById("ts").textContent = nowStr;

            let data;
            try {
              data = JSON.parse(rawData);
            } catch {
              // "48.1%" ã‚„ "humidity:48.1" ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã«ã‚‚å¯¾å¿œ
              data = this.parseFallback(rawData);
            }

            this.addLogEntry(
              `ğŸ“¥ å—ä¿¡: ${
                typeof rawData === "string" ? rawData : JSON.stringify(rawData)
              }`
            );
            this.updateDataDisplay(data);

            // æ¹¿åº¦æŠ½å‡ºï¼ˆã‚­ãƒ¼å€™è£œã‚„ % å«ã¿æ–‡å­—åˆ—ã‹ã‚‰è‡ªå‹•åˆ¤å®šï¼‰
            const hum = this.extractHumidity(data);
            if (typeof hum === "number" && isFinite(hum)) {
              this.updateHumidityUI(hum, nowStr);
              this.updateChart(hum, nowStr);
            }
          } catch (error) {
            console.error("ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
            this.addLogEntry(`âŒ ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
          }
        }

        parseFallback(text) {
          // "humidity:48.1" / "æ¹¿åº¦=48.1%" / "48.1%" / 48.1 ãªã©ã‚’ã‚«ãƒãƒ¼
          if (typeof text !== "string") return { value: String(text) };
          const trimmed = text.trim();

          // æ•°å€¤ã ã‘ãªã‚‰ value ã¨ã—ã¦æ‰±ã†
          const num = parseFloat(trimmed.replace("%", ""));
          if (
            !isNaN(num) &&
            (trimmed.match(/[0-9.]/g) || []).length >=
              String(num).replace(".", "").length
          ) {
            // % ãŒã‚ã‚Œã°æ¹¿åº¦ã¨ã¿ãªã™
            if (trimmed.includes("%")) return { humidity: num };
            return { value: trimmed, humidity: num }; // æ¨å®š
          }

          // "humidity: 48.1" / "æ¹¿åº¦=48.1%" ãªã©
          const re = /(humidity|hum|æ¹¿åº¦)\s*[:=]\s*([0-9]+(?:\.[0-9]+)?)%?/i;
          const m = trimmed.match(re);
          if (m) return { humidity: parseFloat(m[2]) };

          return { value: trimmed };
        }

        extractHumidity(obj) {
          if (!obj || typeof obj !== "object") return undefined;
          // å€™è£œã‚­ãƒ¼ã‚’å„ªå…ˆçš„ã«è¦‹ã‚‹
          const keys = Object.keys(obj);
          for (const k of keys) {
            const lower = k.toLowerCase();
            if (lower.includes("humid") || k === "æ¹¿åº¦") {
              const v = parseFloat(String(obj[k]).toString().replace("%", ""));
              if (!isNaN(v)) return v;
            }
          }
          // å€™è£œã‚­ãƒ¼ãŒç„¡ã„ãŒã€å€¤ã« % ãŒä»˜ã„ã¦ã„ã‚Œã°æ¡ç”¨
          for (const k of keys) {
            const v = obj[k];
            if (typeof v === "string" && v.includes("%")) {
              const n = parseFloat(v.replace("%", ""));
              if (!isNaN(n)) return n;
            }
          }
          return undefined;
        }

        updateDataDisplay(data) {
          // å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
          Object.keys(data).forEach((key) => {
            const value = data[key];
            this.createOrUpdateDataCard(key, value);
          });
        }

        createOrUpdateDataCard(label, value) {
          const safeId = label.replace(/[^a-zA-Z0-9_-]/g, "_");
          const cardId = `card-${safeId}`;
          let card = document.getElementById(cardId);

          if (!card) {
            card = document.createElement("div");
            card.className = "data-card";
            card.id = cardId;
            card.innerHTML = `
              <div class="data-label">${this.formatLabel(label)}</div>
              <div class="data-value" id="value-${safeId}">--</div>
              <div class="data-unit" id="unit-${safeId}"></div>
            `;
            document.getElementById("dataDisplay").appendChild(card);
          }

          const valueElement = document.getElementById(`value-${safeId}`);
          const unitElement = document.getElementById(`unit-${safeId}`);

          if (valueElement) {
            valueElement.textContent = this.formatValue(value);
            valueElement.classList.add("pulse");
            setTimeout(() => valueElement.classList.remove("pulse"), 500);
          }
          if (unitElement) {
            unitElement.textContent = this.guessUnit(label, value);
          }
        }

        formatLabel(label) {
          const map = {
            temperature: "æ¸©åº¦",
            humidity: "æ¹¿åº¦",
            pressure: "æ°—åœ§",
            distance: "è·é›¢",
            voltage: "é›»åœ§",
            current: "é›»æµ",
            speed: "é€Ÿåº¦",
            angle: "è§’åº¦",
            value: "å€¤",
            sensor: "ã‚»ãƒ³ã‚µãƒ¼å€¤",
            data: "ãƒ‡ãƒ¼ã‚¿",
          };
          const lower = label.toLowerCase();
          return map[lower] || label;
        }

        formatValue(value) {
          if (typeof value === "number") return value.toFixed(2);
          const v = String(value);
          // "48.1%" ãªã©ã¯ãã®ã¾ã¾
          const maybeNum = parseFloat(v.replace("%", ""));
          if (!isNaN(maybeNum) && v.includes("%")) return v;
          return v;
        }

        guessUnit(label, value) {
          const lower = label.toLowerCase();
          if (lower.includes("temp")) return "Â°C";
          if (lower.includes("humid")) return "%";
          if (lower.includes("pressure")) return "hPa";
          if (lower.includes("distance")) return "cm";
          if (lower.includes("voltage")) return "V";
          if (lower.includes("current")) return "A";
          if (lower.includes("speed")) return "m/s";
          if (lower.includes("angle")) return "Â°";
          // å€¤ã« % ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°å˜ä½ã‚’å‡ºã•ãªã„ï¼ˆå€¤ã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ï¼‰
          if (typeof value === "string" && value.includes("%")) return "";
          return "";
        }

        updateConnectionStatus(connected) {
          const statusElement = document.getElementById("connectionStatus");
          if (connected) {
            statusElement.innerHTML =
              '<span class="connected">âœ… Arduinoæ¥ç¶šä¸­</span>';
          } else {
            statusElement.innerHTML =
              '<span class="disconnected">âŒ Arduinoåˆ‡æ–­</span>';
          }
        }

        updateLastUpdateTime() {
          const now = new Date();
          const timeString = now.toLocaleTimeString("ja-JP");
          document.getElementById(
            "lastUpdate"
          ).textContent = `æœ€çµ‚æ›´æ–°: ${timeString}`;
        }

        addLogEntry(message) {
          const log = document.getElementById("dataLog");
          const entry = document.createElement("div");
          entry.className = "log-entry";
          const timestamp = new Date().toLocaleTimeString("ja-JP");
          entry.textContent = `[${timestamp}] ${message}`;
          log.appendChild(entry);

          const entries = log.querySelectorAll(".log-entry");
          if (entries.length > this.maxLogEntries) entries[0].remove();
          log.scrollTop = log.scrollHeight;
        }

        showError(message) {
          const el = document.getElementById("errorMessage");
          el.textContent = message;
          el.style.display = "block";
        }
        hideError() {
          document.getElementById("errorMessage").style.display = "none";
        }

        /* ========== æ¹¿åº¦UI/çŠ¶æ…‹ ========== */
        setStatus(kind, text) {
          const dot = document.getElementById("dot");
          const st = document.getElementById("statusText");
          if (dot) {
            dot.classList.remove("ok", "connecting", "offline");
            dot.classList.add(kind);
          }
          if (st) st.textContent = text ?? "";
        }

        updateHumidityUI(hum, timeStr) {
          const humEl = document.getElementById("hum");
          if (humEl) {
            humEl.textContent = hum.toFixed(1);
            humEl.classList.add("pulse");
            setTimeout(() => humEl.classList.remove("pulse"), 400);
          }
          const ts = document.getElementById("ts");
          if (ts) ts.textContent = timeStr;
        }

        /* ========== ã‚°ãƒ©ãƒ• ========== */
        initializeChart() {
          const ctx = document.getElementById("humChart")?.getContext("2d");
          if (!ctx || !window.Chart) return;
          this.humChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: [],
              datasets: [
                {
                  label: "æ¹¿åº¦(%)",
                  data: [],
                  tension: 0.25,
                  pointRadius: 0,
                },
              ],
            },
            options: {
              animation: false,
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { display: false },
                y: { min: 0, max: 100, ticks: { stepSize: 10 } },
              },
              plugins: { legend: { display: false } },
            },
          });
        }

        updateChart(hum, timeStr) {
          if (!this.humChart) return;
          const ds = this.humChart.data.datasets[0].data;
          const labels = this.humChart.data.labels;

          ds.push(hum);
          labels.push(timeStr);
          this.humHistory.push({ time: timeStr, value: hum });

          // å¤ã„ç‚¹ã‚’é–“å¼•ã
          while (ds.length > this.maxPoints) {
            ds.shift();
            labels.shift();
          }
          while (this.humHistory.length > this.maxPoints) {
            this.humHistory.shift();
          }

          this.humChart.update("none");
        }

        bindButtons() {
          const clearBtn = document.getElementById("clearBtn");
          const csvBtn = document.getElementById("csvBtn");

          clearBtn?.addEventListener("click", () => {
            if (this.humChart) {
              this.humChart.data.labels = [];
              this.humChart.data.datasets[0].data = [];
              this.humChart.update();
            }
            this.humHistory = [];
            const humEl = document.getElementById("hum");
            if (humEl) humEl.textContent = "--";
            document.getElementById("ts").textContent = "--:--:--";
            this.addLogEntry("ğŸ§¹ æ¹¿åº¦ã‚°ãƒ©ãƒ•ã¨å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
          });

          csvBtn?.addEventListener("click", () => {
            if (this.humHistory.length === 0) {
              this.addLogEntry("â„¹ï¸ CSVå‡ºåŠ›: ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
              return;
            }
            const header = "time,humidity\n";
            const rows = this.humHistory
              .map((r) => `${r.time},${r.value.toFixed(2)}`)
              .join("\n");
            const blob = new Blob([header + rows], {
              type: "text/csv;charset=utf-8;",
            });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = `humidity_${this.timestampForFile()}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            this.addLogEntry("ğŸ’¾ CSVã‚’ä¿å­˜ã—ã¾ã—ãŸ");
          });
        }

        timestampForFile() {
          const d = new Date();
          const pad = (n) => String(n).padStart(2, "0");
          return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(
            d.getDate()
          )}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
        }
      }

      // ã‚¢ãƒ—ãƒªé–‹å§‹
      document.addEventListener("DOMContentLoaded", () => {
        new ArduinoDataDisplay();
      });
    </script>
  </body>
</html>
